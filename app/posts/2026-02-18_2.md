---
date: 2026-02-18 23:58
title: Rustの勉強[RefCell<T> その3 & Weak<T> その1]
category: ぎじゅつ
draft: false
tags:
  - Rust
---

## はじめに

<https://doc.rust-jp.rs/book-ja/>
を読んでいる

## お勉強

- `RefCell`をやっていた
- `RefCell`から普遍や可変参照する方法
  - この答えはメソッド名は忘れたが特定のメソッドを呼ぶと`deref`が実装された型が返ってくる

<https://doc.rust-jp.rs/book-ja/ch15-05-interior-mutability.html#rct%E3%81%A8refcellt%E3%82%92%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B%E3%82%8B%E3%81%93%E3%81%A8%E3%81%A7%E5%8F%AF%E5%A4%89%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E8%A4%87%E6%95%B0%E3%81%AE%E6%89%80%E6%9C%89%E8%80%85%E3%82%92%E6%8C%81%E3%81%9F%E3%81%9B%E3%82%8B>
ここやる

### メモ

> `Rc<T>`と`RefCell<T>`を組み合わせることで可変なデータに複数の所有者を持たせる

- 理解はできるな
- `Rc<RefCell<T>>`かな

```rust
#[derive(Debug)]
enum List {
Cons(Rc<RefCell<i32>>, Rc<List>),
Nil,
}

use crate::List::{Cons, Nil};
use std::cell::RefCell;
use std::rc::Rc;

fn main() {
let value = Rc::new(RefCell::new(5));

    let a = Rc::new(Cons(Rc::clone(&value), Rc::new(Nil)));

    let b = Cons(Rc::new(RefCell::new(3)), Rc::clone(&a));
    let c = Cons(Rc::new(RefCell::new(4)), Rc::clone(&a));

    *value.borrow_mut() += 10;

    println!("a after = {:?}", a);
    println!("b after = {:?}", b);
    println!("c after = {:?}", c);

}
```

- やはりそうだね

- `Rc::clone(&a)`
  - これしているからcountが3になるのかな

- `let a = Rc::new(Cons(Rc::clone(&value), Rc::new(Nil)));`
  - これもか
  - ここでもいけるな

```bash
$ cargo run
Compiling cons-list v0.1.0 (file:///projects/cons-list)
Finished dev [unoptimized + debuginfo] target(s) in 0.63s
Running `target/debug/cons-list`
a after = Cons(RefCell { value: 15 }, Nil)
b after = Cons(RefCell { value: 3 }, Cons(RefCell { value: 15 }, Nil))
c after = Cons(RefCell { value: 4 }, Cons(RefCell { value: 15 }, Nil))
```

- そうね、全部同じ値をポインタとして参照しているのか
- やりたくねーこんな複雑なこと
- `RefCell`終わった

<https://doc.rust-jp.rs/book-ja/ch15-06-reference-cycles.html#%E5%BE%AA%E7%92%B0%E5%8F%82%E7%85%A7%E3%81%AF%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%92%E3%83%AA%E3%83%BC%E3%82%AF%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%82%82%E3%81%82%E3%82%8B>

- それはそうやろ
- そもそも循環参照ってgoの静的解析で怒られなかったっけ

## まとめ

- 今回大して学びはない
- 普通に使いたくないなとしか思わなかった
